---
title: "Docker 20.10ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã®ã§è©¦ã—ã¦ã¿ã‚‹è©±"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker"]
published: true
---

ã“ã‚Œã¯[Docker Advent Calendar 2020](https://qiita.com/advent-calendar/2020/docker)9æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

å‰å›ã€Docker 20.10ã®æ–°æ©Ÿèƒ½ã«ã¤ã„ã¦è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚
[Docker 20.10ã®ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’çœºã‚ã‚‹](https://zenn.dev/inductor/articles/7377f6b914d19a4e12c8)

ãã‚Œã‹ã‚‰2ãƒ¶æœˆå¼±çµŒéã—ã¾ã—ãŸãŒã€Docker 20.10ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚

è‹±èªã§è©³ç´°ã«ã¾ã¨ã¾ã£ãŸè¨˜äº‹ãŒã“ã¡ã‚‰ã«ã‚ã‚Šã¾ã™ã®ã§ã€åˆã‚ã›ã¦ã”è¦§ãã ã•ã„ã€‚
https://medium.com/nttlabs/docker-20-10-59cc4bd59d37

ä»Šå›ã¯`Fedora 33`ã«å…¥ã‚Œã¦å‹•ã‹ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```
$ cat /etc/redhat-release
Fedora release 33 (Thirty Three)
```

```bash
$ curl -fsSL https://get.docker.com/ | sh
# Executing docker install script, commit: 3d8fe77c2c46c5b7571f94b42793905e5b3e42e4
+ sh -c 'dnf install -y -q dnf-plugins-core'
+ sh -c 'dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo'
Adding repo from: https://download.docker.com/linux/fedora/docker-ce.repo
+ '[' stable '!=' stable ']'
+ sh -c 'dnf makecache'
Docker CE Stable - x86_64                                                                99 kB/s | 4.9 kB     00:00
Fedora 33 openh264 (From Cisco) - x86_64                                                955  B/s | 989  B     00:01
Fedora Modular 33 - x86_64                                                              8.0 kB/s | 6.4 kB     00:00
Fedora Modular 33 - x86_64 - Updates                                                    7.9 kB/s | 6.3 kB     00:00
Fedora 33 - x86_64 - Updates                                                            4.6 kB/s | 4.6 kB     00:00
Fedora 33 - x86_64 - Updates                                                            275 kB/s | 461 kB     00:01
Fedora 33 - x86_64                                                                      7.9 kB/s | 6.5 kB     00:00
Metadata cache created.
+ '[' -n '' ']'
+ sh -c 'dnf install -y -q docker-ce'
warning: /var/cache/dnf/docker-ce-stable-ce8c657c263a7868/packages/containerd.io-1.4.3-3.1.fc33.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID 621e9f35: NOKEY
Importing GPG key 0x621E9F35:
 Userid     : "Docker Release (CE rpm) <docker@docker.com>"
 Fingerprint: 060A 61C5 1B55 8A7F 742B 77AA C52F EB6B 621E 9F35
 From       : https://download.docker.com/linux/fedora/gpg
If you would like to use Docker as a non-root user, you should now consider
adding your user to the "docker" group with something like:

  sudo usermod -aG docker your-user

Remember that you will have to log out and back in for this to take effect!

WARNING: Adding a user to the "docker" group will grant the ability to run
         containers which can be used to obtain root privileges on the
         docker host.
         Refer to https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface
         for more information.
```

DockerãŒå…¥ã‚Šã¾ã—ãŸã€‚

```bash
$ docker version
Client: Docker Engine - Community
 Version:           20.10.0
 API version:       1.41
 Go version:        go1.13.15
 Git commit:        7287ab3
 Built:             Tue Dec  8 19:00:39 2020
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      true

Server: Docker Engine - Community
 Engine:
  Version:          20.10.0
  API version:      1.41 (minimum version 1.12)
  Go version:       go1.13.15
  Git commit:       eeddea2
  Built:            Tue Dec  8 18:58:12 2020
  OS/Arch:          linux/amd64
  Experimental:     false
 containerd:
  Version:          1.4.3
  GitCommit:        269548fa27e0089a8b8278fc4fc781d7f65a939b
 runc:
  Version:          1.0.0-rc92
  GitCommit:        ff819c7e9184c13b7c2607fe6c30ae19403a7aff
 docker-init:
  Version:          0.19.0
  GitCommit:        de40ad0
```

containerdãŒ`1.4.3`ã«ä¸ŠãŒã£ã¦ã„ã‚‹ã®ã¨ã€runcãŒ`1.0.0-rc92`ã«ä¸ŠãŒã£ã¦ã„ã¾ã—ãŸã€‚

## host.docker.internal ã‚’ä½¿ã£ã¦ã¿ã‚‹

å€‹äººçš„ã«æ°—ã«ãªã£ã¦ãŸ `host.docker.internal` ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã‚„ã¤ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

ç¾çŠ¶ã¯ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«add-hostã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã§ã™ã€‚

```
$ docker run -it --add-host=host.docker.internal:host-gateway
# apt update && apt install iputils-ping -y
# ping host.docker.internal
PING host.docker.internal (172.17.0.1) 56(84) bytes of data.
64 bytes from host.docker.internal (172.17.0.1): icmp_seq=1 ttl=64 time=0.066 ms
64 bytes from host.docker.internal (172.17.0.1): icmp_seq=2 ttl=64 time=0.064 ms
64 bytes from host.docker.internal (172.17.0.1): icmp_seq=3 ttl=64 time=0.080 ms
```

ã¡ã‚ƒã‚“ã¨ãƒ›ã‚¹ãƒˆã«æ¥ç¶šã§ãã¦ã„ã‚‹ã£ã½ã„ã€‚

æ¬¡ã¯buildxå‘¨ã‚Šã®å‹•ãã‚’ç¢ºã‹ã‚ã¦ã¿ã¾ã™ã€‚

Growiã®DockerfileãŒæ–°ã—ã„è¨˜æ³•ã§æ›¸ã‹ã‚Œã¦ã‚‹ã£ã½ã„ã®ã§è©¦ã—ã¦ã¿ã‚‹ã€‚experimentalã®ãƒ•ãƒ©ãƒƒã‚°ã‚’æ¶ˆã—ã¦ãŠãã€‚

Ref. https://github.com/weseek/growi/blob/master/docker/Dockerfile

```diff
-# syntax = docker/dockerfile:experimental

ARG flavor=default

```

```
$ git clone https://github.com/weseek/growi.git && cd growi
$ docker buildx build --file ./docker/Dockerfile .
WARN[0000] invalid non-bool value for BUILDX_NO_DEFAULT_LOAD:
[+] Building 16.1s (16/32)
 => => extracting sha256:9b921803d598f1331175a7fde4fa93cf1a814c3f007055ed499a64bc0cda7c47                                                                                              0.3s
 => [internal] load metadata for docker.io/library/node:14-alpine                                                                                                                      3.4s
 => [internal] load metadata for docker.io/library/node:14-slim                                                                                                                        3.5s
 => [deps-resolver 1/8] FROM docker.io/library/node:14-slim@sha256:8e8fe9db471bf84c19f55b0b842320edf1c8f35e03416727f814d50f55bd13f3                                                    4.7s
 => => resolve docker.io/library/node:14-slim@sha256:8e8fe9db471bf84c19f55b0b842320edf1c8f35e03416727f814d50f55bd13f3                                                                  0.0s
 => => sha256:8e8fe9db471bf84c19f55b0b842320edf1c8f35e03416727f814d50f55bd13f3 776B / 776B                                                                                             0.0s
 => => sha256:48619db9da7dfd7f22a13aee46e2c1336b56fadf6eb53fa17a50b341befc9b63 1.37kB / 1.37kB                                                                                         0.0s
 => => sha256:b361b0e6694e7e5c57a9c33b4c67ca6be8441c3d009102fbe886953d68e15285 7.09kB / 7.09kB                                                                                         0.0s
 => => sha256:4297e02295585beb3f148a5740b644ce87e059455f8d98a5adb7bf95105e011c 22.53MB / 22.53MB                                                                                       1.0s
 => => sha256:f75ab7205508cf2e0ea5af53fc3b581ee51128cea912048925f97a4c9ae2eeb1 4.15kB / 4.15kB                                                                                         0.9s
 => => sha256:fd483bc31a42fe31017f25529c920bfd2bcb18473e64d846c1425d2c6e82dfea 35.31MB / 35.31MB                                                                                       1.6s
 => => sha256:5611f0b964d834bba124edab86151760d492aa2d7b8b2586c85ba6e220e85889 2.81MB / 2.81MB                                                                                         1.2s
....
 => [builder 1/5] WORKDIR /opt/growi                                                                                                                                                                                                                                     0.0s
 => [builder 2/5] RUN yarn build:prod                                                                                                                                                                                                                                   68.2s

ARG flavor=default
 => [builder 3/5] WORKDIR /tmp                                                                                                                                                                                                                                           0.0s
 => [builder 4/5] RUN --mount=target=. sh docker/bin/remove-except-artifacts.sh                                                                                                                                                                                          5.3s
 => [builder 5/5] WORKDIR /opt/growi                                                                                                                                                                                                                                     0.0s
 => [stage-5 6/7] COPY --from=builder --chown=node:node   /opt/growi /opt/growi                                                                                                                                                                                          0.2s
 => [stage-5 7/7] WORKDIR /opt/growi                                                                                                                                                                                                                                     0.0s
 => exporting to image                                                                                                                                                                                                                                                   3.8s
 => => exporting layers                                                                                                                                                                                                                                                  3.8s
 => => writing image sha256:3a0e3c61327a117045b5dd765d7de1e33a59389d475e69eacc2297b2845495c0                                                                                                                                                                             0.0s
```

experimentalæ¶ˆã—ã¦ã‚‚å‹•ã„ãŸã‹ã‚‰å¤šåˆ†æ–°ã—ã„è¨˜æ³•ã§ã„ã‘ã¦ã‚‹ã£ã¦ã“ã¨ã£ã½ã„ã§ã™ã­

ã‚ã¨ã¤ã„ã§ã«æ°—ã¥ã„ãŸã‚“ã§ã™ãŒ`buildx`ãŒãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã˜ã‚ƒãªãã¦çµ„ã¿è¾¼ã¿ã§ç›´æ¥ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã™ã­ã€‚ã“ã‚Œã¯ä¾¿åˆ©ã ã€‚

## è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠ

```
$ docker scan ubuntu:20.04
```

ã“ã‚Œã¯ç¾çŠ¶Linuxç‰ˆã§ã¯ä½¿ãˆãªã„ã‚‰ã—ãæ–­å¿µã€‚ã ã‘ã©Windows/Macç‰ˆã§ã¯ä½¿ãˆã‚‹ã‚‰ã—ã„ã£ã™ã‚ˆã€‚ã‚ˆã•ãã†ã€‚

snykã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä½¿ã£ã¦ã„ã‚‹ãã†ã§ã™ã€‚

## ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§CentOS 8 / Fedoraã§Dockerä½¿ã„ãŸã„äººã«ã¯å¬‰ã—ã„20.10ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã—ãŸãŒã€ä»–ã«ã‚‚ãªã«ã’ã«å¬‰ã—ã„æ©Ÿèƒ½ãŒç››ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã—ãŸã€‚